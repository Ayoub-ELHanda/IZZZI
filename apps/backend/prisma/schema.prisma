generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String             @id @default(uuid())
  email                  String             @unique
  password               String?
  firstName              String
  lastName               String
  role                   UserRole           @default(VISITEUR)
  authProvider           AuthProvider       @default(LOCAL)
  googleId               String?            @unique
  establishmentId        String?
  isEmailVerified        Boolean            @default(false)
  isActive               Boolean            @default(true)
  profilePicture         String?
  resetPasswordToken     String?            @unique
  resetPasswordExpires   DateTime?
  emailVerificationToken String?            @unique
  invitedBy              String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  stripeCustomerId       String?            @unique
  subscriptionStatus     SubscriptionStatus @default(FREE)
  trialEndDate           DateTime?
  alerts                 Alert[]
  classes                Class[]
  notifications          Notification[]
  payments               Payment[]
  subjects               Subject[]
  subscriptions          Subscription[]
  establishment          Establishment?     @relation(fields: [establishmentId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([establishmentId])
  @@index([invitedBy])
  @@index([stripeCustomerId])
}

model Establishment {
  id        String   @id @default(uuid())
  name      String
  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  classes   Class[]
  users     User[]

  @@index([createdBy])
}

model Class {
  id              String        @id @default(uuid())
  name            String
  createdBy       String
  establishmentId String
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  description     String?
  studentCount    Int
  studentEmails   String[]
  isArchived      Boolean       @default(false)
  archivedAt      DateTime?
  archivedBy      String?
  user            User          @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  establishment   Establishment @relation(fields: [establishmentId], references: [id], onDelete: Cascade)
  subjects        Subject[]

  @@index([createdBy])
  @@index([establishmentId])
  @@index([isArchived])
}

model Subject {
  id             String          @id @default(uuid())
  name           String
  classId        String
  createdBy      String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  teacherName    String
  teacherEmail   String?
  startDate      DateTime
  endDate        DateTime
  questionnaires Questionnaire[]
  class          Class           @relation(fields: [classId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([classId])
  @@index([createdBy])
}

model Questionnaire {
  id              String                   @id @default(uuid())
  type            QuestionnaireType
  subjectId       String
  token           String                   @unique
  qrCodeUrl       String?
  isActive        Boolean                  @default(true)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt
  formType        FormType                 @default(BASIC)
  alerts          Alert[]
  feedbackSummary FeedbackSummary?
  notifications   Notification[]
  subject         Subject                  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  statistics      QuestionnaireStatistics?
  responses       Response[]

  @@index([subjectId])
  @@index([token])
}

model Response {
  id              String        @id @default(uuid())
  questionnaireId String
  rating          Int
  comment         String?
  isAnonymous     Boolean       @default(true)
  studentEmail    String?
  createdAt       DateTime      @default(now())
  questionnaire   Questionnaire @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)

  @@index([questionnaireId])
  @@index([createdAt])
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String
  stripeSubscriptionId String             @unique
  stripePriceId        String
  stripeProductId      String
  status               SubscriptionStatus @default(ACTIVE)
  billingPeriod        BillingPeriod
  classCount           Int
  pricePerClass        Int
  totalAmount          Int
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean            @default(false)
  canceledAt           DateTime?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  payments             Payment[]
  user                 User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeSubscriptionId])
  @@index([status])
}

model Payment {
  id                    String        @id @default(uuid())
  userId                String
  subscriptionId        String?
  stripePaymentIntentId String        @unique
  stripeInvoiceId       String?
  amount                Int
  currency              String        @default("eur")
  status                PaymentStatus
  paymentMethod         String?
  last4                 String?
  metadata              Json?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  subscription          Subscription? @relation(fields: [subscriptionId], references: [id])
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([subscriptionId])
  @@index([stripePaymentIntentId])
  @@index([status])
}

model Notification {
  id              String           @id @default(uuid())
  userId          String
  type            NotificationType
  title           String
  message         String
  questionnaireId String?
  isRead          Boolean          @default(false)
  readAt          DateTime?
  createdAt       DateTime         @default(now())
  questionnaire   Questionnaire?   @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([questionnaireId])
}

model Alert {
  id              String           @id @default(uuid())
  userId          String
  questionnaireId String
  type            NotificationType
  message         String
  status          AlertStatus      @default(UNTREATED)
  treatedAt       DateTime?
  treatedBy       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  comment         String?
  questionnaire   Questionnaire    @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([questionnaireId])
  @@index([status])
  @@index([createdAt])
}

model FeedbackSummary {
  id                String        @id @default(uuid())
  questionnaireId   String        @unique
  summary           String
  sentiment         String
  strengths         String[]
  improvements      String[]
  pedagogicalAlerts String[]
  generatedAt       DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  questionnaire     Questionnaire @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)

  @@index([questionnaireId])
  @@index([generatedAt])
}

model QuestionnaireStatistics {
  id                        String        @id @default(uuid())
  questionnaireId           String        @unique
  temporalRatingData        Json?
  temporalSatisfactionData  Json?
  overallRatingDistribution Json?
  theoryPracticeRatio       Json?
  courseAtmosphere          Json?
  courseHours               Json?
  contentRelevance          Json?
  clarityDistribution       Json?
  teachingSpeed             Json?
  strongPoints              Json?
  weakPoints                Json?
  generatedAt               DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt
  questionnaire             Questionnaire @relation(fields: [questionnaireId], references: [id], onDelete: Cascade)

  @@index([questionnaireId])
  @@index([generatedAt])
}

enum UserRole {
  VISITEUR
  RESPONSABLE_PEDAGOGIQUE
  ADMIN
  SUPER_ADMIN
}

enum AuthProvider {
  LOCAL
  GOOGLE
}

enum SubscriptionStatus {
  FREE
  ACTIVE
  PAST_DUE
  CANCELED
  INCOMPLETE
  TRIALING
}

enum BillingPeriod {
  MONTHLY
  ANNUAL
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum QuestionnaireType {
  DURING_COURSE
  AFTER_COURSE
}

enum FormType {
  BASIC
  TECHNICAL
  SOFT_SKILLS
  LOGICIEL
}

enum NotificationType {
  ALERT_POSITIVE
  ALERT_NEGATIVE
}

enum AlertStatus {
  UNTREATED
  TREATED
}
